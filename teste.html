<!DOCTYPE html>
<html>
<head>
  <title>SaveMe</title>
</head>
<body>
  <div id="charging"></div>
  <div id="level"></div>
  <div id="dischargingTime"></div>
  
  <br><br>
  <div id="location"></div>
  
  <br><br>
  <a href="tel:193">Ligue agora para os bombeiros</a>
  
  <br><br>
  <div id="aX">Ax: </div>
  <div id="aY">Ay: </div>
  <div id="aZ">Az: </div>
  
  <br><br>
  <div id="chartContainer" style="height: 300px; width:100%;"></div>
</body>


<!-- Maps API Javascript -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB5nAx_lxyFF3ZQHXd1PGf-PmGUzczDAU8"></script>

<!-- Chart Update API -->
<script type="text/javascript" src="canvasjs.min.js"></script>

<!-- Position and Speech API -->
<script type="text/javascript">
window.onload = function () {
  function updateBatteryStatus(battery) {
	//update 'labels' from page
	
	//battery
	document.querySelector('#charging').textContent = battery.charging ? 'charging' : 'not charging';
	document.querySelector('#level').textContent = battery.level * 100 + "%";
	document.querySelector('#dischargingTime').textContent = battery.dischargingTime / 60 + " minutes";
	
	//Location
	//document.querySelector('#location').textContent = currentPosition();
	
	//Accelerometer
	accelerometer();
	
	//Chart
	chartUpdater();
}
	function currentPosition(){
		if (!navigator.geolocation){
			//can't acess geolocation source
			alert("Geolocation is not supported by your browser");
		}
		else{
			//have location
			function success(position) {
				var latitude  = position.coords.latitude;
				var longitude = position.coords.longitude;
				var msg = "Olá eu acabei de me acidentar no seguinte endereço: ";
				
				//Have internet connection
				if(navigator.onLine){
					var geocoder = new google.maps.Geocoder;
					var latlng = {lat: parseFloat(latitude), lng: parseFloat(longitude)};
					
					//Coordinates to Readable coordinates
					geocoder.geocode({'location': latlng}, function(results, status) {
					if (status === google.maps.GeocoderStatus.OK) {
						//found
						if (results[1]) {
							msg += results[1].formatted_address;
							
							//Update 'label' message
							document.querySelector('#location').textContent = msg;
							
							//create a speech messeger
							var msgSpeech = new SpeechSynthesisUtterance(msg);
							window.speechSynthesis.speak(msgSpeech);
					  
						} else {
							//can't convert to readable coordinates
							window.alert('No results found');
						}
					} else {
						//can't use geocode
						window.alert('Geocoder failed due to: ' + status);
					}
					});
					
				}
				else{
					//don't have internet, so use the lat and long
					msg += "Latitude: " + latitude + "   Longitude: " + longitude;
					alert("Estou offline");
					
					//update 'label' message
					document.querySelector('#location').textContent = msg;
					
					//create a speech messeger
					var msgSpeech = new SpeechSynthesisUtterance(msg);
					window.speechSynthesis.speak(msgSpeech);
				}
			}
			function error() {
				//don't find location
				alert("Unable to retrieve your location");
			};

			  //alert("Locating…");

			  navigator.geolocation.getCurrentPosition(success, error);
		}
	}

	function accelerometer(){
		if (window.DeviceMotionEvent == undefined){
			//don't have accelerometer.
			alert ("Don't have accelerometer!");
		}
		else{
			//Accelerometer is present
			window.addEventListener("devicemotion",accelerometerUpdate, true);
		
			function accelerometerUpdate(e){
				var aX = event.accelerationIncludingGravity.x*1;
				var aY = event.accelerationIncludingGravity.y*1;
				var aZ = event.accelerationIncludingGravity.z*1;
				
				document.querySelector('#aX').textContent = aX;
				document.querySelector('#aY').textContent = "aY: " + aY;
				document.querySelector('#aZ').textContent = "aZ: " + aZ;
			}
		}
	}
	
	function chartUpdater(){
		var dpsX = []; //dataPoints
		var dpsY = []; //dataPoints
		var dpsZ = []; //dataPoints
		
		var chart = new CanvasJS.Chart("chartContainer",{
			title: {text: "Accelerometer Chart"},
			data: [{
				type: "line",
				dataPoints: dpsX
			},
			{
				type: "line",
				dataPoints: dpsY
			},
			{
				type: "line",
				dataPoints: dpsZ
			}]
		});
		
		var xVal = 0;
		var ValY = 100;	
		var ValX = 100;	
		var ValZ = 100;
		var updateInterval = 10;
		var dataLength = 5000; // number of dataPoints visible at any point
		
		var updateChart = function (count) {
			count = count || 1;
			// count is number of times loop runs to generate random dataPoints.
			
			for (var j = 0; j < count; j++) {	
				ValY = document.querySelector('#aY').textContent;
				dpsY.push({
					x: xVal,
					y: ValY
				});
				ValX = document.querySelector('#aX').textContent;
				dpsX.push({
					x: xVal,
					y: ValX
				});
				ValZ = document.querySelector('#aZ').textContent;
				dpsZ.push({
					x: xVal,
					y: ValZ
				});
				xVal++;
			};
			if (dpsY.length > dataLength)
			{
				dpsY.shift();				
			}
			if (dpsX.length > dataLength)
			{
				dpsX.shift();				
			}
			if (dpsZ.length > dataLength)
			{
				dpsZ.shift();				
			}
			
			chart.render();		

		};

		// generates first set of dataPoints
		updateChart(dataLength); 

		// update chart after specified time. 
		setInterval(function(){updateChart()}, updateInterval); 
	}
	
  navigator.getBattery().then(function(battery) {
	// Update the battery status initially when the promise resolves ...
	updateBatteryStatus(battery);

	// .. and for any subsequent updates.
	battery.onchargingchange = function () {
	  updateBatteryStatus(battery);
	};

	battery.onlevelchange = function () {
	  updateBatteryStatus(battery);
	};

	battery.ondischargingtimechange = function () {
	  updateBatteryStatus(battery);
	};
  });
};
</script>

</html>